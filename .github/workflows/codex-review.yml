name: Codex review trigger

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: codex-review-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - name: Post @codex review comment (once)
        uses: actions/github-script@v7
        with:
          script: |
            const skipLabel = 'skip-codex'
            const triggerText = '@codex review'

            const pr = context.payload.pull_request
            const owner = context.repo.owner
            const repo = context.repo.repo
            const issue_number = pr.number

            const labels = (pr.labels || []).map(l => l.name)
            if (labels.includes(skipLabel)) {
              core.info(`Skipping Codex trigger because label '${skipLabel}' is present.`)
              return
            }

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            })

            const alreadyCommented = comments.some(c => (c.body || '').trim() === triggerText)
            if (alreadyCommented) {
              core.info(`Codex trigger comment already exists on PR #${issue_number}.`)
              return
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: triggerText,
            })